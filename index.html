<html>
	<head>
		<title>Test</title>
		<style type="text/css">
		img {
			max-width: 500px;

		}

		</style>

	</head>
	<body>
		<h1>Preload test</h1>	
		

		
		<script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.min.js" ></script>
	


		<div class="firstTest" >
			<h1>2 Workin image with same ref and different callbacks: </h1>
			<img data-lazy-src="http://bit.fieramilano.it/sites/default/files/logo%20bit2015.png" src="http://www.ajaxload.info/images/exemples/25.gif" />

			<img data-lazy-src="http://bit.fieramilano.it/sites/default/files/logo%20bit2015.png" src="http://www.ajaxload.info/images/exemples/25.gif" data-lazy-callback="borderRed" />


			
		</div>

		<div class="secondTest" >
			<h1>Image 404 (should remain the loader, but the image border should become green)</h1>
			<img  
				data-lazy-callback="borderRed"  
				data-lazy-src="http://www.kongtechnology.com/wp-content/uploads/see-how-your-google-results-measure-up-with-google-grader-video.jpg"  
				src="http://www.ajaxload.info/images/exemples/25.gif"  
				data-lazy-error-src="http://www.problogger.net/wp-content/uploads/2007/09/404-page-not-found.jpg" />
		</div>

		<div class="errorTest" >
			<h1>Image 404 (should remain the loader, but the image border should become green)</h1>
			<img 
				data-lazy-src="http://www.kongtechnology.com/wp-content/uploads/see-how-your-google-results-measure-up-with-google-grader-videoadsd.jpg"  
				src="http://www.ajaxload.info/images/exemples/25.gif"  
				data-lazy-error-src="http://www.problogger.net/wp-content/uploads/2007/09/404-page-not-found.jpg" 
				data-lazy-callback="borderGreen"
			/>
		</div>

		<div class="thirdTest" >
			<h1>do a for each (3 images should appears)</h1>
			<img data-lazy-src="http://purrfectcatnames.com/wp-content/uploads/2013/11/Gray-Cat-MorgueFile-Nov16th-2013.jpg"  src="http://www.ajaxload.info/images/exemples/25.gif" />
			<img data-lazy-src="http://www.nose2tail.co.uk/cat-matlock-derbyshire.jpg"    src="http://www.ajaxload.info/images/exemples/25.gif" />
			<img data-lazy-src="http://animalpetdoctor.homestead.com/acat5.jpg"  src="http://www.ajaxload.info/images/exemples/25.gif" />
		</div>

		<div>end one</div>

		<script type="text/javascript">

			var ImageLoader = (function ImageLoader(){
				
				this.images  = {};
				this.getImagePromise = function(url){
					if(!this.images[url])
					{ 
						 var imagePromise = new Promise(
						    function(resolve, reject) 
						    {  
						    	console.log('getImagePromise');
						    	var image = new Image()
								image.src = url;
								$(image)
									.load(function(){
										resolve(true);
									 })
									.error(function(){
										resolve(false);
									});
						    }
						);
						this.images[url] = imagePromise;
					}
					
					return this.images[url];
				}

				return this;
			})();

		</script>

		<script type="text/javascript">
			
		var ImagesLazyLoading = (function(){

			var settings = null;

			var init = function(config){
				 settings= $.extend(
				 	{
				 		'watch': false
				 	}, 
				 	config
				 );

				 changeUrls();
				 
				 if(!!settings.watch)
				 {

				 	watchDomChanges();
				 }

			};


			function changeUrls(){
				$("img[data-lazy-src]").not(".data-lazy-loaded").each(function(){
					
					var $this = $(this);
					var _src2Load = $this.attr('data-lazy-src');

					var p = ImageLoader.getImagePromise(_src2Load);

					p.then(function(success){
						if(success)
						{
							$this.attr('src', _src2Load);
						}
						else
						{
							$this.attr('src', $this.attr('data-lazy-error-src'));	
						}

						$this.addClass('data-lazy-loaded');

						var callbackName = $this.attr('data-lazy-callback');
						
						if(typeof(callbackName) === 'string'  && typeof(window[callbackName]) === 'function' ){
							window[callbackName].call($this.get(), success);
						}


					})
				});

			}

			var observeDOM = (function(){
			    var MutationObserver = window.MutationObserver || window.WebKitMutationObserver,
			        eventListenerSupported = window.addEventListener;

			    return function(obj, callback){
			        if( MutationObserver ){
			            // define a new observer
			            var obs = new MutationObserver(function(mutations, observer){
			                if( mutations[0].addedNodes.length || mutations[0].removedNodes.length )
			                    callback();
			            });

			            console.log("obj: "+obj)
			            // have the observer observe foo for changes in children
			            obs.observe( obj, { childList:true, subtree:true });
			        }
			        else if( eventListenerSupported ){
			            obj.addEventListener('DOMNodeInserted', callback, false);
			            obj.addEventListener('DOMNodeRemoved', callback, false);
			        }
			    }
			})();

			

			function watchDomChanges(){

				console.log("watchDomChanges");
				observeDOM( $('body').get(0) ,function(){ 
					changeUrls();
				});
			}


			return {
				'init': init,
				'refresh': changeUrls,
			}

		})();
		
		
		</script>

		<script type="text/javascript">
				$(document).ready(function(){

					ImagesLazyLoading.init({
						watch: true
					});



					var $firstTest = $('.firstTest img');
					var $secondTest = $('.secondTest img');
					var $thirdTest = $('.thirdTest img');


					window.borderGreen = function(){
						console.log('borderGreen');
						$(this).css('border', '1px solid green');
					}
					window.borderRed = function(){
						console.log('borderRed');
						$(this).css('border', '1px solid red');
					}
				});
		</script>



		<script>
			function addImage(){
					console.log(' ------ aftertimeout ------ ');

					$('body').append('<img  data-lazy-src="http://www.kongtechnology.com/wp-content/uploads/see-how-your-google-results-measure-up-with-google-grader-videoadsd.jpg"   src="http://www.ajaxload.info/images/exemples/25.gif" data-lazy-error-src="http://www.problogger.net/wp-content/uploads/2007/09/404-page-not-found.jpg" data-lazy-callback="borderGreen" />')
					.append('<img data-lazy-src="http://bit.fieramilano.it/sites/default/files/logo%20bit2015.png" src="http://www.ajaxload.info/images/exemples/25.gif" data-lazy-callback="borderRed" />')
					.append('<img data-lazy-src="https://www.petfinder.com/wp-content/uploads/2012/11/122163343-conditioning-dog-loud-noises-632x475.jpg" src="http://www.ajaxload.info/images/exemples/25.gif" data-lazy-callback="borderRed" />');

					//ImagesLazyLoading.refresh();

				}

				setTimeout(addImage, 10000);

				setTimeout(addImage, 15000);
		</script>



		<div id="alert" ></div>

	</body>


</html>